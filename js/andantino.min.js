function AI(a){this.game=null;this.color=a;this.point=new Point(0,0);this.thinking=false}AI.prototype={toString:function(){return"["+this.color+" computer]"},move:function(){var a=null;var b=this.game.grayHexes.head.next;while(b!=this.game.grayHexes.head){if(this.point.equals(b.data.p)){a=b.data}b=b.next}if(a==null){return}this.game.play(a)},think:function(){this.game.winner=null;this.thinking=true;var j=this.game.grayHexes.size;var g=new List();for(var e=0;e<j;++e){this.point=this.game.grayHexes.first().p;this.move();g.pushBack({len:this.game.getLongestFromLastPlay(),p:this.point});if(this.game.winner!=null){this.game.undo();this.thinking=false;return}this.game.undo()}this.game.nextTurn();for(e=0;e<j;++e){this.point=this.game.grayHexes.first().p;this.move();if(this.game.winner!=null){this.game.undo();this.game.nextTurn();this.thinking=false;return}this.game.undo()}this.game.nextTurn();var f,b,c;var h=this.game.grayHexes.head.prev;while(h!=this.game.grayHexes.head){this.point=h.data.p;this.move();c=this.game.grayHexes.head.prev;f=this.point;while(c!=this.game.grayHexes.head){this.game.winner=null;this.point=c.data.p;this.move();if(this.game.winner!=null){g.remove(h.data);this.game.undo();break}this.game.undo();c=c.prev}this.point=f;h=h.prev;this.game.undo()}var a=0;h=g.head.next;while(h!=g.head){if(h.data.len>a){a=h.data.len;this.point=h.data.p}h=h.next}this.thinking=false},thinkAndMove:function(){this.think();this.move()},drawMouse:function(){mouseHex=new Hex(this.point);if(this.color=="blue"){mouseHex.color="rgba(100,100,250,0.4)"}else{mouseHex.color="rgba(250,100,100,0.4)"}this.game.draw();mouseHex.draw(this.game.ctx,g_size)},};function Game(b,a){this.initGraphics();this.p1=b;this.p2=a;this.p1.game=this;this.p2.game=this;this.winner=null;this.currentPlayer=b;this.otherPlayer=a;this.playedHexes=new List();this.unplayedHexes=new List();this.grayHexes=new List();this.mouse=new Point(0,0)}Game.prototype={init:function(){h1=new Hex(new Point(0,0));h2=new Hex(new Point(0,1));h1.ptrs[5]=h2;h2.ptrs[2]=h1;this.colorHex(h1,"blue");this.colorHex(h2,"red")},initGraphics:function(){this.canvas=document.getElementById("canvas");this.canvas.width=$(document).width();this.canvas.height=$(document).height();this.ctx=this.canvas.getContext("2d");this.ctx.translate($(document).width()/2,$(document).height()/2)},start:function(){$("#canvas").mousedown(g_mouseDown);$("#canvas").mouseup(g_mouseUp);$("#canvas").click(function(a){g_game.currentPlayer.move()});$("#canvas").mousemove(g_mouseMove);$(document).keypress(g_keyPress);$("#zin").click(g_zin);$("#zout").click(g_zout);$("#undo").click(function(a){g_game.undo();g_game.draw()})},stop:function(){$("#canvas").unbind();$(document).unbind();$("#zin").unbind();$("#zout").unbind();$("#undo").unbind()},draw:function(){this.ctx.save();this.ctx.translate(-g_trans.x,-g_trans.y);this.ctx.clearRect(-$(document).width()/2,-$(document).height()/2,$(document).width(),$(document).height());this.ctx.restore();this.playedHexes.iterate(function(b){b.draw(document.getElementById("canvas").getContext("2d"),g_size)});this.grayHexes.iterate(function(b){b.draw(document.getElementById("canvas").getContext("2d"),g_size)});this.ctx.save();var a=this.playedHexes.last().p;this.ctx.translate(1.5*a.x*g_size,(a.y*1.732-0.866*a.x)*g_size);this.ctx.beginPath();this.ctx.arc(0,0,g_size/3,0,Math.PI*2,true);this.ctx.closePath();this.ctx.fill();this.ctx.restore()},colorHex:function(a,b){a.color=b;this.unplayedHexes.remove(a);this.playedHexes.pushBack(a);a.buildNeighbors(this);this.draw()},undo:function(c){if(this.playedHexes.size<=2){return}var b=this.playedHexes.popBack();for(var a=0;a<6;++a){if(b.ptrs[a]!=null){--b.ptrs[a].touching;if(b.ptrs[a].touching==1&&!b.ptrs[a].p.equals(new Point(0,0))&&!b.ptrs[a].p.equals(new Point(0,1))){b.ptrs[a].color="white";this.grayHexes.remove(b.ptrs[a])}}}this.nextTurn();this.grayHexes.pushBack(b);b.color="lightgray";this.winner==null},setTurn:function(a){if(this.otherPlayer==a){this.otherPlayer=this.currentPlayer;this.currentPlayer=a}},nextTurn:function(){this.setTurn(this.otherPlayer);if(this.currentPlayer instanceof AI&&!this.currentPlayer.thinking){if(this.currentPlayer.color==g_p1.color){setTimeout("g_p1.thinkAndMove()",100)}else{setTimeout("g_p2.thinkAndMove()",100)}}},play:function(a){this.grayHexes.remove(a);this.colorHex(a,this.currentPlayer.color);if(this.checkWin(a)){this.winner=this.currentPlayer;if(!this.currentPlayer.thinking&&!this.otherPlayer.thinking){this.win()}else{this.nextTurn()}}else{this.nextTurn()}},getLongestFromLastPlay:function(){var a=0;var b=0;var e;for(var c=0;c<3;++c){e=this.playedHexes.last();b=1;while(e.ptrs[c]!=null&&e.ptrs[c].color==this.otherPlayer.color){b+=1;e=e.ptrs[c]}e=this.playedHexes.last();while(e.ptrs[c+3]!=null&&e.ptrs[c+3].color==this.otherPlayer.color){b+=1;e=e.ptrs[c+3]}a=Math.max(a,b)}return a},checkWin:function(g){var b;var a;for(var f=0;f<3;++f){a=g;b=1;while(a.ptrs[f]!=null&&a.ptrs[f].color==this.currentPlayer.color){b+=1;a=a.ptrs[f]}a=g;while(a.ptrs[f+3]!=null&&a.ptrs[f+3].color==this.currentPlayer.color){b+=1;a=a.ptrs[f+3]}if(b>=5){return true}}var a,c,j,l;for(var f=0;f<5;++f){if(g.ptrs[f]!=null&&g.ptrs[f].color==this.currentPlayer.color){a=g.ptrs[f];l=false;j=f-2;c=f-2;while(a!=g){while(a.ptrs[(((c%6)+6)%6)]!=null&&a.ptrs[(((c%6)+6)%6)].color!=this.currentPlayer.color){l|=(a.ptrs[(((c%6)+6)%6)].color==this.otherPlayer.color);++c}a=a.ptrs[(((c%6)+6)%6)];c-=2}if(c-j-3<0&&l){return true}}}var a,c,j,e;var k="red";if(this.currentPlayer.color=="red"){k="blue"}for(var f=0;f<5;++f){if(g.ptrs[f]!=null&&g.ptrs[f].color==this.currentPlayer){a=g.ptrs[f];e=false;j=f-2;c=f-2;while(a!=g){while(a.ptrs[(((c%6)+6)%6)]!=null&&a.ptrs[(((c%6)+6)%6)].color!=this.currentPlayer){e|=(a.ptrs[(((c%6)+6)%6)].color==k);++c}a=a.ptrs[(((c%6)+6)%6)];c-=2}if(c-j-3<0&&e){return true}}}return false},win:function(){this.stop();$("#win").dialog({title:this.currentPlayer.color.charAt(0).toUpperCase()+this.currentPlayer.color.slice(1)+" wins!",resizable:false,width:350,height:80,close:function(){$("#menu").dialog("open")}}).text("Hit escape to go to the main menu.")}};function Hex(a){this.p=a;this.color="white";this.touching=0;this.ptrs=new Array(null,null,null,null,null,null)}Hex.prototype={dirList:new Array(-1,-1,0,1,1,0),toString:function(){return"["+this.color+" hex at "+this.p+"]"},buildNeighbors:function(f){for(var c=0;c<6;++c){var a,g,b,e;if(this.ptrs[c]==null){a=new Point(this.p.x+Hex.prototype.dirList[c],this.p.y+Hex.prototype.dirList[(c+5)%6]);g=f.unplayedHexes.head.next;b=false;while(g!=f.unplayedHexes.head){if(g.data.p.equals(a)){b=true;break}g=g.next}if(b){e=g.data}else{e=new Hex(a);f.unplayedHexes.pushBack(e)}if(this.ptrs[(c+5)%6]!=null){this.ptrs[(c+5)%6].ptrs[(c+1)%6]=e;e.ptrs[(c+4)%6]=this.ptrs[(c+5)%6]}if(this.ptrs[(c+1)%6]!=null){this.ptrs[(c+1)%6].ptrs[(c+5)%6]=e;e.ptrs[(c+2)%6]=this.ptrs[(c+1)%6]}this.ptrs[c]=e;e.ptrs[(c+3)%6]=this}this.ptrs[c].touching++;if(this.ptrs[c].touching==2&&!this.ptrs[c].p.equals(new Point(0,0))&&!this.ptrs[c].p.equals(new Point(0,1))){this.ptrs[c].color="lightgray";this.ptrs[c].draw(f.ctx,20);f.grayHexes.pushBack(this.ptrs[c])}}},draw:function(a,b){if(this.color=="white"){return}a.save();a.translate(1.5*this.p.x*b,(this.p.y*1.732-0.866*this.p.x)*b);a.beginPath();a.moveTo(-0.5*b,-0.866*b);a.lineTo(0.5*b,-0.866*b);a.lineTo(b,0);a.lineTo(0.5*b,0.866*b);a.lineTo(-0.5*b,0.866*b);a.lineTo(-b,0);a.closePath();a.stroke();a.fillStyle=this.color;a.fill();a.restore()},equals:function(a){return this.p.x==a.p.x&&this.p.y==a.p.y}};function HumanPlayer(a){this.game=null;this.color=a;this.point=new Point(0,0)}HumanPlayer.prototype={toString:function(){return"["+this.color+" human]"},move:function(){var a=null;var b=this.game.grayHexes.head.next;while(b!=this.game.grayHexes.head){if(this.point.equals(b.data.p)){a=b.data}b=b.next}if(a==null){return}this.game.play(a)},drawMouse:function(){mouseHex=new Hex(this.point);if(this.color=="blue"){mouseHex.color="rgba(100,100,250,0.4)"}else{mouseHex.color="rgba(250,100,100,0.4)"}this.game.draw();mouseHex.draw(this.game.ctx,g_size)}};function List(){this.head={prev:null,next:null};this.head.next=this.head;this.head.prev=this.head;this.size=0}List.prototype={toString:function(){if(this.size==0){return"[]"}var a="["+this.head.next.data;var b=this.head.next;while(b.next!=this.head){b=b.next;a+=", "+b.data}return a+"]"},pushFront:function(a){++this.size;var b={data:a,prev:this.head,next:this.head.next};this.head.next=b;b.next.prev=b},pushBack:function(a){++this.size;var b={data:a,prev:this.head.prev,next:this.head};this.head.prev=b;b.prev.next=b},popFront:function(){if(this.size==0){return}d=this.head.next.data;this.head.next.next.prev=this.head;this.head.next=this.head.next.next;--this.size;return d},popBack:function(){if(this.size==0){return}d=this.head.prev.data;this.head.prev.prev.next=this.head;this.head.prev=this.head.prev.prev;--this.size;return d},first:function(){return this.head.next.data},last:function(){return this.head.prev.data},empty:function(){this.size=0;this.head.next=this.head;this.head.prev=this.head},remove:function(a){var b=this.head.next;while(b!=this.head){if(a==b.data){b.prev.next=b.next;b.next.prev=b.prev;--this.size;return a}b=b.next}return},has:function(a){var b=this.head.next;while(b!=this.head){if(b.data==a){return true}b=b.next}return false},iterate:function(a){var b=this.head.next;while(b!=this.head){a(b.data);b=b.next}},iterateReverse:function(a){var b=this.head.prev;while(b!=this.head){a(b.data);b=b.prev}}};var g_size=20;var g_game;var g_p1,g_p2;var g_click=new Point(0,0);var g_trans=new Point(0,0);var g_isMouseDown=false;$(document).ready(function(){$("#cc").button({disabled:true});$("#howto").hide();$("#first").hide();$("button").button().css("width",250);$("#menu").dialog({title:"Andantino",width:275,closeOnEscape:false,draggable:false,resizable:false,open:function(a,b){$(".ui-dialog-titlebar-close").hide()}}).css("text-align","center");$("#hh").click(function(a){$("#menu").dialog("close");g_p1=new HumanPlayer("blue");g_p2=new HumanPlayer("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start()});$("#cc").click(function(a){$("#menu").dialog("close");g_p1=new AI("blue");g_p2=new AI("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start()});$("#hc").click(function(a){$("#menu").dialog("close");g_p1=new HumanPlayer("blue");g_p2=new HumanPlayer("red");$("#first").dialog({title:"Who plays first?",width:275,height:130,closeOnEscape:false,open:function(b,c){$(".ui-dialog-titlebar-close").hide()},draggable:false,resizable:false}).css("text-align","center");$("#first").show()});$("#hFirst").click(function(a){$("#first").dialog("close");g_p1=new HumanPlayer("blue");g_p2=new AI("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start()});$("#cFirst").click(function(a){$("#first").dialog("close");g_p1=new AI("blue");g_p2=new HumanPlayer("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start();setTimeout("g_p1.thinkAndMove()",100)});$("#rules").click(function(a){$("#howto").dialog({title:"How to play Andantino",width:500,closeOnEscape:false,draggable:false,resizable:false,open:function(b,c){$(".ui-dialog-titlebar-close").hide()}});$("#menu").dialog("close");$("#howto").show()});$(".backToMenu").click(function(){$("#howto").dialog("close");$("#first").dialog("close");$("#menu").dialog("open")})});function g_zout(){g_size-=2;if(g_size<=6){g_size=6}g_game.draw()}function g_zin(){g_size+=2;if(g_size>=40){g_size=40}g_game.draw()}function g_mouseDown(a){g_click=new Point(a.offsetX,a.offsetY);g_isMouseDown=true}function g_mouseUp(a){g_isMouseDown=false}function g_keyPress(a){if(a.which==49){g_zin()}else{if(a.which==50){g_zout()}else{if(a.which==117){g_game.undo()}}}}function g_mouseMove(b){var a=g_game.currentPlayer;var c=new Point(b.offsetX,b.offsetY);a.point=new Point(Math.round((c.x*2-$(document).width()-2*g_trans.x)/(3*g_size)),0);a.point.add(new Point(0,Math.round((c.y-$(document).height()/2-g_trans.y)/(1.732*g_size)+a.point.x/2)));a.drawMouse();if(g_isMouseDown){g_game.ctx.translate(b.offsetX-g_click.x,b.offsetY-g_click.y);g_trans.add(c).sub(g_click);g_click=c;g_game.draw()}}function Point(a,b){this.x=a;this.y=b}Point.prototype={toString:function(){return"("+this.x+", "+this.y+")"},add:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a){this.x-=a.x;this.y-=a.y;return this},equals:function(a){return this.x==a.x&&this.y==a.y},adjacentTo:function(a){return(Math.abs(this.x-a.x)+Math.abs(this.y-a.y)==1)||(this.x-a.x)*(this.y-a.y)==1}};