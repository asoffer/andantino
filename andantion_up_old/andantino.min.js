function AI(c){this.game=null;this.color=c;this.point=new Point(0,0);this.thinking=false;}AI.prototype={toString:function(){return"["+this.color+" computer]";},move:function(){var hex=null;var ptr=this.game.grayHexes.head.next;while(ptr!=this.game.grayHexes.head){if(this.point.equals(ptr.data.p)){hex=ptr.data;}ptr=ptr.next;}if(hex==null){return;}this.game.play(hex);},think:function(){this.game.winner=null;this.thinking=true;var n=this.game.grayHexes.size;var list=new List();for(var i=0;i<n;++i){this.point=this.game.grayHexes.first().p;this.move();list.pushBack({len:this.game.getLongestFromLastPlay(),p:this.point});if(this.game.winner!=null){this.game.undo();this.thinking=false;return;}this.game.undo();}this.game.nextTurn();for(i=0;i<n;++i){this.point=this.game.grayHexes.first().p;this.move();if(this.game.winner!=null){this.game.undo();this.game.nextTurn();this.thinking=false;return;}this.game.undo();}this.game.nextTurn();var oldPt,end,ptr2;var ptr=this.game.grayHexes.head.prev;while(ptr!=this.game.grayHexes.head){this.point=ptr.data.p;this.move();ptr2=this.game.grayHexes.head.prev;oldPt=this.point;while(ptr2!=this.game.grayHexes.head){this.game.winner=null;this.point=ptr2.data.p;this.move();if(this.game.winner!=null){list.remove(ptr.data);this.game.undo();break;}this.game.undo();ptr2=ptr2.prev;}this.point=oldPt;ptr=ptr.prev;this.game.undo();}var m=0;ptr=list.head.next;while(ptr!=list.head){if(ptr.data.len>m){m=ptr.data.len;this.point=ptr.data.p;}ptr=ptr.next;}this.thinking=false;},thinkAndMove:function(){this.think();this.move();},drawMouse:function(){mouseHex=new Hex(this.point);if(this.color=="blue"){mouseHex.color="rgba(100,100,250,0.4)";}else{mouseHex.color="rgba(250,100,100,0.4)";}this.game.draw();mouseHex.draw(this.game.ctx,g_size);},};function Game(p1,p2){this.initGraphics();this.p1=p1;this.p2=p2;this.p1.game=this;this.p2.game=this;this.winner=null;this.currentPlayer=p1;this.otherPlayer=p2;this.playedHexes=new List();this.unplayedHexes=new List();this.grayHexes=new List();this.mouse=new Point(0,0);}Game.prototype={init:function(){h1=new Hex(new Point(0,0));h2=new Hex(new Point(0,1));h1.ptrs[5]=h2;h2.ptrs[2]=h1;this.colorHex(h1,"blue");this.colorHex(h2,"red");},initGraphics:function(){this.canvas=document.getElementById("canvas");this.canvas.width=document.width;this.canvas.height=document.height;this.ctx=this.canvas.getContext("2d");this.ctx.translate(document.width/2,document.height/2);},start:function(){$("#canvas").mousedown(g_mouseDown);$("#canvas").mouseup(g_mouseUp);$("#canvas").click(function(event){g_game.currentPlayer.move();});$("#canvas").mousemove(g_mouseMove);$(document).keypress(g_keyPress);$("#zin").click(g_zin);$("#zout").click(g_zout);$("#undo").click(function(event){g_game.undo();g_game.draw();});},stop:function(){$("#canvas").unbind();$(document).unbind();$("#zin").unbind();$("#zout").unbind();$("#undo").unbind();},draw:function(){this.ctx.save();this.ctx.translate(-g_trans.x,-g_trans.y);this.ctx.clearRect(-document.width/2,-document.height/2,document.width,document.height);this.ctx.restore();this.playedHexes.iterate(function(h){h.draw(document.getElementById("canvas").getContext("2d"),g_size);});this.grayHexes.iterate(function(h){h.draw(document.getElementById("canvas").getContext("2d"),g_size);});this.ctx.save();var p=this.playedHexes.last().p;this.ctx.translate(1.5*p.x*g_size,(p.y*1.732-0.866*p.x)*g_size);this.ctx.beginPath();this.ctx.arc(0,0,g_size/3,0,Math.PI*2,true);this.ctx.closePath();this.ctx.fill();this.ctx.restore();},colorHex:function(h,c){h.color=c;this.unplayedHexes.remove(h);this.playedHexes.pushBack(h);h.buildNeighbors(this);this.draw();},undo:function(event){if(this.playedHexes.size<=2){return;}var h=this.playedHexes.popBack();for(var i=0;i<6;++i){if(h.ptrs[i]!=null){--h.ptrs[i].touching;if(h.ptrs[i].touching==1&&!h.ptrs[i].p.equals(new Point(0,0))&&!h.ptrs[i].p.equals(new Point(0,1))){h.ptrs[i].color="white";this.grayHexes.remove(h.ptrs[i]);}}}this.nextTurn();this.grayHexes.pushBack(h);h.color="lightgray";this.winner==null;},setTurn:function(p){if(this.otherPlayer==p){this.otherPlayer=this.currentPlayer;this.currentPlayer=p;}},nextTurn:function(){this.setTurn(this.otherPlayer);if(this.currentPlayer instanceof AI&&!this.currentPlayer.thinking){if(this.currentPlayer.color==g_p1.color){setTimeout("g_p1.thinkAndMove()",100);}else{setTimeout("g_p2.thinkAndMove()",100);}}},play:function(hex){this.grayHexes.remove(hex);this.colorHex(hex,this.currentPlayer.color);if(this.checkWin(hex)){this.winner=this.currentPlayer;if(!this.currentPlayer.thinking&&!this.otherPlayer.thinking){this.win();}else{this.nextTurn();}}else{this.nextTurn();}},getLongestFromLastPlay:function(){var m=0;var counter=0;var ptr;for(var i=0;i<3;++i){ptr=this.playedHexes.last();counter=1;while(ptr.ptrs[i]!=null&&ptr.ptrs[i].color==this.otherPlayer.color){counter+=1;ptr=ptr.ptrs[i];}ptr=this.playedHexes.last();while(ptr.ptrs[i+3]!=null&&ptr.ptrs[i+3].color==this.otherPlayer.color){counter+=1;ptr=ptr.ptrs[i+3];}m=Math.max(m,counter);}return m;},checkWin:function(h){var counter;var ptr;for(var i=0;i<3;++i){ptr=h;counter=1;while(ptr.ptrs[i]!=null&&ptr.ptrs[i].color==this.currentPlayer.color){counter+=1;ptr=ptr.ptrs[i];}ptr=h;while(ptr.ptrs[i+3]!=null&&ptr.ptrs[i+3].color==this.currentPlayer.color){counter+=1;ptr=ptr.ptrs[i+3];}if(counter>=5){return true;}}var ptr,dir,initDir,found;for(var i=0;i<5;++i){if(h.ptrs[i]!=null&&h.ptrs[i].color==this.currentPlayer.color){ptr=h.ptrs[i];found=false;initDir=i-2;dir=i-2;while(ptr!=h){while(ptr.ptrs[(((dir%6)+6)%6)]!=null&&ptr.ptrs[(((dir%6)+6)%6)].color!=this.currentPlayer.color){found|=(ptr.ptrs[(((dir%6)+6)%6)].color==this.otherPlayer.color);++dir;}ptr=ptr.ptrs[(((dir%6)+6)%6)];dir-=2;}if(dir-initDir-3<0&&found){return true;}}}var ptr,dir,initDir,sur;var surColor="red";if(this.currentPlayer.color=="red"){surColor="blue";}for(var i=0;i<5;++i){if(h.ptrs[i]!=null&&h.ptrs[i].color==this.currentPlayer){ptr=h.ptrs[i];sur=false;initDir=i-2;dir=i-2;while(ptr!=h){while(ptr.ptrs[(((dir%6)+6)%6)]!=null&&ptr.ptrs[(((dir%6)+6)%6)].color!=this.currentPlayer){sur|=(ptr.ptrs[(((dir%6)+6)%6)].color==surColor);++dir;}ptr=ptr.ptrs[(((dir%6)+6)%6)];dir-=2;}if(dir-initDir-3<0&&sur){return true;}}}return false;},win:function(){this.stop();$("#win").dialog({title:this.currentPlayer.color.charAt(0).toUpperCase()+this.currentPlayer.color.slice(1)+" wins!",resizable:false,width:350,height:80,close:function(){$("#menu").dialog("open");}}).text("Hit escape to go to the main menu.");}};function Hex(p){this.p=p;this.color="white";this.touching=0;this.ptrs=new Array(null,null,null,null,null,null);}Hex.prototype={dirList:new Array(-1,-1,0,1,1,0),toString:function(){return"["+this.color+" hex at "+this.p+"]";},buildNeighbors:function(gm){for(var i=0;i<6;++i){var newPt,ptr,goodBreak,h;if(this.ptrs[i]==null){newPt=new Point(this.p.x+Hex.prototype.dirList[i],this.p.y+Hex.prototype.dirList[(i+5)%6]);ptr=gm.unplayedHexes.head.next;goodBreak=false;while(ptr!=gm.unplayedHexes.head){if(ptr.data.p.equals(newPt)){goodBreak=true;break;}ptr=ptr.next;}if(goodBreak){h=ptr.data;}else{h=new Hex(newPt);gm.unplayedHexes.pushBack(h);}if(this.ptrs[(i+5)%6]!=null){this.ptrs[(i+5)%6].ptrs[(i+1)%6]=h;h.ptrs[(i+4)%6]=this.ptrs[(i+5)%6];}if(this.ptrs[(i+1)%6]!=null){this.ptrs[(i+1)%6].ptrs[(i+5)%6]=h;h.ptrs[(i+2)%6]=this.ptrs[(i+1)%6];}this.ptrs[i]=h;h.ptrs[(i+3)%6]=this;}this.ptrs[i].touching++;if(this.ptrs[i].touching==2&&!this.ptrs[i].p.equals(new Point(0,0))&&!this.ptrs[i].p.equals(new Point(0,1))){this.ptrs[i].color="lightgray";this.ptrs[i].draw(gm.ctx,20);gm.grayHexes.pushBack(this.ptrs[i]);}}},draw:function(ctx,s){if(this.color=="white"){return;}ctx.save();ctx.translate(1.5*this.p.x*s,(this.p.y*1.732-0.866*this.p.x)*s);ctx.beginPath();ctx.moveTo(-0.5*s,-0.866*s);ctx.lineTo(0.5*s,-0.866*s);ctx.lineTo(s,0);ctx.lineTo(0.5*s,0.866*s);ctx.lineTo(-0.5*s,0.866*s);ctx.lineTo(-s,0);ctx.closePath();ctx.stroke();ctx.fillStyle=this.color;ctx.fill();ctx.restore();},equals:function(h){return this.p.x==h.p.x&&this.p.y==h.p.y;}};function HumanPlayer(c){this.game=null;this.color=c;this.point=new Point(0,0);}HumanPlayer.prototype={toString:function(){return"["+this.color+" human]";},move:function(){var hex=null;var ptr=this.game.grayHexes.head.next;while(ptr!=this.game.grayHexes.head){if(this.point.equals(ptr.data.p)){hex=ptr.data;}ptr=ptr.next;}if(hex==null){return;}this.game.play(hex);},drawMouse:function(){mouseHex=new Hex(this.point);if(this.color=="blue"){mouseHex.color="rgba(100,100,250,0.4)";}else{mouseHex.color="rgba(250,100,100,0.4)";}this.game.draw();mouseHex.draw(this.game.ctx,g_size);}};function List(){this.head={prev:null,next:null};this.head.next=this.head;this.head.prev=this.head;this.size=0;}List.prototype={toString:function(){if(this.size=0){return"[]";}var str="["+this.head.next.data;var ptr=this.head.next;while(ptr.next!=this.head){ptr=ptr.next;str+=", "+ptr.data;}return str+"]";},pushFront:function(d){++this.size;var n={data:d,prev:this.head,next:this.head.next};this.head.next=n;n.next.prev=n;},pushBack:function(d){++this.size;var n={data:d,prev:this.head.prev,next:this.head};this.head.prev=n;n.prev.next=n;},addAfter:function(d,fn){var ptr=this.head.next;while(fn(ptr.data)){ptr=ptr.next;if(ptr==this.head){return this.pushBack(d);}}var n={data:d,prev:ptr,next:ptr.next};ptr.next=n;n.next.prev=n;},popFront:function(){if(this.size==0){return;}d=this.head.next.data;this.head.next.next.prev=this.head;this.head.next=this.head.next.next;--this.size;return d;},popBack:function(){if(this.size==0){return;}d=this.head.prev.data;this.head.prev.prev.next=this.head;this.head.prev=this.head.prev.prev;--this.size;return d;},first:function(){return this.head.next.data;},last:function(){return this.head.prev.data;},empty:function(){this.size=0;this.head.next=this.head;this.head.prev=this.head;},remove:function(data){var ptr=this.head.next;while(ptr!=this.head){if(data.equals(ptr.data)){ptr.prev.next=ptr.next;ptr.next.prev=ptr.prev;--this.size;return data;}ptr=ptr.next;}return;},iterate:function(fn){var ptr=this.head.next;while(ptr!=this.head){fn(ptr.data);ptr=ptr.next;}},iterateReverse:function(fn){var ptr=this.head.prev;while(ptr!=this.head){fn(ptr.data);ptr=ptr.prev;}}};var g_size=20;var g_game;var g_p1,g_p2;var g_click=new Point(0,0);var g_trans=new Point(0,0);var g_isMouseDown=false;$(document).ready(function(){$("#cc").button({disabled:true});$("#howto").hide();$("#first").hide();$("button").button().css("width",250);$("#menu").dialog({title:"Andantino",closeOnEscape:false,draggable:false,resizable:false,open:function(event,ui){$(".ui-dialog-titlebar-close").hide();}}).css("text-align","center");$("#hh").click(function(event){$("#menu").dialog("close");g_p1=new HumanPlayer("blue");g_p2=new HumanPlayer("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start();});$("#cc").click(function(event){$("#menu").dialog("close");g_p1=new AI("blue");g_p2=new AI("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start();});$("#hc").click(function(event){$("#menu").dialog("close");g_p1=new HumanPlayer("blue");g_p2=new HumanPlayer("red");$("#first").dialog({title:"Who plays first?",width:290,closeOnEscape:false,open:function(event,ui){$(".ui-dialog-titlebar-close").hide();},draggable:false,resizable:false}).css("text-align","center");$("#first").show();});$("#hFirst").click(function(event){$("#first").dialog("close");g_p1=new HumanPlayer("blue");g_p2=new AI("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start();});$("#cFirst").click(function(event){$("#first").dialog("close");g_p1=new AI("blue");g_p2=new HumanPlayer("red");g_game=new Game(g_p1,g_p2);g_game.init();g_game.draw();g_game.start();setTimeout("g_p1.thinkAndMove()",100);});$("#rules").click(function(event){$("#howto").dialog({title:"How to play Andantino",width:600,closeOnEscape:false,draggable:false,resizable:false,open:function(event,ui){$(".ui-dialog-titlebar-close").hide();}});$("#menu").dialog("close");$("#howto").show();});$(".backToMenu").click(function(){$("#howto").dialog("close");$("#menu").dialog("open");});});function g_zout(){g_size-=2;if(g_size<=6){g_size=6;}g_game.draw();}function g_zin(){g_size+=2;if(g_size>=40){g_size=40;}g_game.draw();}function g_mouseDown(event){g_click=new Point(event.offsetX,event.offsetY);g_isMouseDown=true;}function g_mouseUp(event){g_isMouseDown=false;}function g_keyPress(event){if(event.which==49){g_zin();}else{if(event.which==50){g_zout();}else{if(event.which==117){g_game.undo();}}}}function g_mouseMove(event){var pl=g_game.currentPlayer;var p=new Point(event.offsetX,event.offsetY);pl.point=new Point(Math.round((p.x*2-document.width-2*g_trans.x)/(3*g_size)),0);pl.point.add(new Point(0,Math.round((p.y-document.height/2-g_trans.y)/(1.732*g_size)+pl.point.x/2)));pl.drawMouse();if(g_isMouseDown){g_game.ctx.translate(event.offsetX-g_click.x,event.offsetY-g_click.y);g_trans.add(p).sub(g_click);g_click=p;g_game.draw();}}function Point(x,y){this.x=x;this.y=y;}Point.prototype={toString:function(){return"("+this.x+", "+this.y+")";},add:function(p){this.x+=p.x;this.y+=p.y;return this;},sub:function(p){this.x-=p.x;this.y-=p.y;return this;},equals:function(p){return this.x==p.x&&this.y==p.y;},adjacentTo:function(p){return(Math.abs(this.x-p.x)+Math.abs(this.y-p.y)==1)||(this.x-p.x)*(this.y-p.y)==1;}};